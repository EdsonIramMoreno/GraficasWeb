<html>
<html lang="es">
<head>

	<title>Juego</title>
	<link rel="stylesheet" href="css/juego.css">
	<link rel="stylesheet" href="css/menus.css">

	<script type="text/javascript" src="libs/jquery/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="libs/three/three2.js"></script>
	<script type="text/javascript" src="libs/menus/menu.js"></script>
	<script type="text/javascript" src="libs/three/MTLLoader.js"></script>
	<script type="text/javascript" src="libs/three/OBJLoader.js"></script>
	<script type="text/javascript" src="libs/three/FBXLoader.js"></script>
	<script type="text/javascript" src="libs/three/inflate.min.js"></script>
	<script type="text/javascript">
		function redSettings() {
			var storedList = localStorage.getItem("settings");
			if (storedList == null) {
				settings == [];
			} else {
				settings = JSON.parse(storedList);
			}
			return settings;
		};
	</script>
	<script type="text/javascript">

		var settings = redSettings();
		var gameMode = settings[0].gameMode;

		var scene;
		var camera;
		var renderer;
		var controls;
		var clock;
		var deltaTime;
		var keys = {};

		//Array Objects
		var items = [];

		//Aray for FBX Animations
		var firstCharacterArray = [];
		var secondCharacterArray = [];


		var LOADING_MANAGER = null;
		var RESSOURCES_LOADED = false;

		var paused = false;

		var playerSpeed = 1;

		$(document).ready(function () {
			
			setupScene();

			//#region Walls
			var wallArray = [];

			var wallGeometryH = new THREE.BoxGeometry(50, 5, 1);
			var wallMaterialH = new THREE.MeshPhongMaterial({ color: "pink" });
			var wallNorth = new THREE.Mesh(wallGeometryH, wallMaterialH);
			wallNorth.position.set(0, 0, -2);
			wallNorth.visible = false;
			wallArray.push(wallNorth);

			var wallSouth = wallNorth.clone();
			wallSouth.position.set(0, 0, 25);
			wallArray.push(wallSouth);
			
			var wallGeometryP = new THREE.BoxGeometry(1, 5, 50);
			var wallMaterialP = new THREE.MeshPhongMaterial({ color: "blue" });
			var wallWest = new THREE.Mesh(wallGeometryP, wallMaterialP);
			wallWest.position.set(25, 0, 0);
			wallWest.visible = false;
			wallArray.push(wallWest);
			
			var wallEast = wallWest.clone();
			wallEast.position.set(-25, 0, 0);
			wallArray.push(wallEast);

			scene.add(wallArray[0]);
			scene.add(wallArray[1]);
			scene.add(wallArray[2]);
			scene.add(wallArray[3]);

			//#endregion
			
			//#region Main Character
			var fbxLoader = new THREE.FBXLoader(LOADING_MANAGER);
			fbxLoader.load('assets/Models/Characters/guy.fbx', function (personaje) {
				personaje.position.set(-15, 0, 0);
				personaje.scale.set(0.045, 0.045, 0.045);

				personaje.traverse(function (child) {
					if (child.isMesh) {
						child.castShadow = true;
						child.receiveShadow = true;
					}
				});

				var anim = new THREE.FBXLoader(LOADING_MANAGER);
				anim.load('assets/Models/Characters/anim_idle.fbx', function (anim) {
					personaje.mixer = new THREE.AnimationMixer(personaje);
					firstCharacterArray.push(personaje.mixer);
					var idle = personaje.mixer.clipAction(anim.animations[0]);
					idle.play();
				});
				anim.load('assets/Models/Characters/anim_walk.fbx', function (anim) {
					personaje.mixer = new THREE.AnimationMixer(personaje);
					firstCharacterArray.push(personaje.mixer);
					var walking = personaje.mixer.clipAction(anim.animations[0]);
					walking.play();
				});
				personaje.name = "firstCharacter";
				scene.add(personaje);
			});
			//#endregion

			//#region Second Character
			if(gameMode == "Multijugador"){
				fbxLoader.load('assets/Models/Characters/girl.fbx', function (personaje) {
				personaje.position.set(15, 0, 0);
				personaje.scale.set(0.045, 0.045, 0.045);

				personaje.traverse(function (child) {
					if (child.isMesh) {
						child.castShadow = true;
						child.receiveShadow = true;
					}
				});

				var anim = new THREE.FBXLoader(LOADING_MANAGER);
				anim.load('assets/Models/Characters/anim_idle.fbx', function (anim) {
					personaje.mixer = new THREE.AnimationMixer(personaje);
					secondCharacterArray.push(personaje.mixer);
					var idle = personaje.mixer.clipAction(anim.animations[0]);
					idle.play();
				});
				anim.load('assets/Models/Characters/anim_walk.fbx', function (anim) {
					personaje.mixer = new THREE.AnimationMixer(personaje);
					secondCharacterArray.push(personaje.mixer);
					var walking = personaje.mixer.clipAction(anim.animations[0]);
					walking.play();
				});
				personaje.name = "secondCharacter";
				scene.add(personaje);			
			});
			}
			//#endregion

			//#region Objects

			/*loadOBJWithMTL("assets/Models/Objects/bomba/", "less.obj", "less.mtl", (bomba) => {
				bomba.position.set(10, 0, 0);
				bomba.position.set(1.6, 2.6, 17);
				bomba.scale.set(0.6, 0.6, 0.6);
				bomba.name = "bomba";
				items.push(bomba);
				scene.add(bomba);
			});*/

			loadOBJWithMTL("assets/Models/Objects/lechuga/", "lechuga.obj", "lechuga.mtl", (lechuga) => {
				lechuga.position.set(0, 0, 0);
				lechuga.scale.set(0.9, 0.9, 0.9);
				lechuga.rotation.y = THREE.Math.degToRad(240);
				lechuga.name = "lechuga";
				items.push(lechuga);
				scene.add(lechuga);
			});

			loadOBJWithMTL("assets/Models/Objects/platano/", "platano.obj", "platano.mtl", (platano) => {
				platano.position.set(5, 0, 0);
				platano.scale.set(0.9, 0.9, 0.9);
				platano.rotation.y = THREE.Math.degToRad(320);
				platano.name = "platano";
				items.push(platano);
				scene.add(platano);
			});

			loadOBJWithMTL("assets/Models/Objects/zanahoria/", "zanahoria.obj", "zanahoria.mtl", (zanahoria) => {
				zanahoria.position.set(-5, 0, 0);
				zanahoria.scale.set(0.9, 0.9, 0.9);
				zanahoria.rotation.y = THREE.Math.degToRad(50);
				zanahoria.name = "zanahoria";
				items.push(zanahoria);
				scene.add(zanahoria);
			});

			//#endregion
			
			render();


			document.addEventListener('keydown', onKeyDown);
			document.addEventListener('keyup', onKeyUp);
		});

		function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
			var mtlLoader = new THREE.MTLLoader(LOADING_MANAGER);
			mtlLoader.setPath(path);
			mtlLoader.load(mtlFile, (materials) => {

				var objLoader = new THREE.OBJLoader(LOADING_MANAGER);
				objLoader.setMaterials(materials);
				objLoader.setPath(path);
				objLoader.load(objFile, (object) => {
					onLoadCallback(object);
				});

			});
		}

		function onKeyDown(event) {
			keys[String.fromCharCode(event.keyCode)] = true;
		}

		function onKeyUp(event) {
			keys[String.fromCharCode(event.keyCode)] = false;
		}

		function render() {

			if (!RESSOURCES_LOADED) {
				requestAnimationFrame(render);
				return;
			} else {
			var firstCharacter = scene.getObjectByName("firstCharacter");
			var secondCharacter = scene.getObjectByName("secondCharacter");
			deltaTime = clock.getDelta();


			//#region First Character Move n Animations
			if (keys["A"]) {
				firstCharacter.rotation.y += 5 * deltaTime;
			} else if (keys["D"]) {
				firstCharacter.rotation.y += (-5) * deltaTime;
			}
			if (keys["W"]) {
				firstCharacter.translateZ(10 * deltaTime * playerSpeed);
			} else if (keys["S"]) {
				firstCharacter.translateZ((-10) * deltaTime * playerSpeed);
				
			}

			if (keys["A"] || keys["W"] || keys["S"] || keys["D"]) {
				if (firstCharacterArray.length > 0) {
					firstCharacterArray[1].update(deltaTime);
				}
			} 
			else {
				if (firstCharacterArray.length > 0) {
					firstCharacterArray[0].update(deltaTime);
				}
			}
			//#endregion
			
			
			//#region First Character Move n Animations
			if (keys["J"]) {
				secondCharacter.rotation.y += 5 * deltaTime;
			} else if (keys["L"]) {
				secondCharacter.rotation.y += (-5) * deltaTime;
			}
			if (keys["I"]) {
				secondCharacter.translateZ(10 * deltaTime * playerSpeed);
			} else if (keys["K"]) {
				secondCharacter.translateZ((-10) * deltaTime * playerSpeed);
			}

			if (keys["J"] || keys["K"] || keys["L"] || keys["I"]) {
				if (secondCharacterArray.length > 0) {
					secondCharacterArray[1].update(deltaTime);
				}
			} else {
				if (secondCharacterArray.length > 0) {
					secondCharacterArray[0].update(deltaTime);
				}
			}
			//#endregion

			requestAnimationFrame(render);
			renderer.render(scene, camera);
		}
			
		}

		function setupScene() {

			LOADING_MANAGER = new THREE.LoadingManager();
			LOADING_MANAGER = new THREE.LoadingManager();

			const progressBar = document.getElementById("progress-bar");
			const progressBarContainer = document.getElementById("progress-bar-container");

			LOADING_MANAGER.onProgress = function (url, loaded, total) {
				progressBar.value = (loaded / total) * 100;
			}

			LOADING_MANAGER.onLoad = function () {


				$(".progress-bar-container").hide();
				RESSOURCES_LOADED = true;
			}

			var visibleSize = {
				width: window.innerWidth,
				height: window.innerHeight
			};

			clock = new THREE.Clock();
			scene = new THREE.Scene();
			scene.background = new THREE.Color("#34495E");
			camera = new THREE.PerspectiveCamera(45, (visibleSize.width / visibleSize.height), 0.1, 300);
			camera.position.z = 35;
			camera.position.y = 50;
			camera.rotation.x = -45;

			renderer = new THREE.WebGLRenderer();
			renderer.setClearColor(new THREE.Color(0, 0, 0));
			renderer.setPixelRatio(visibleSize.width / visibleSize.height);
			renderer.setSize(visibleSize.width, visibleSize.height);

			//ILUMINACION AMBIENTAL


			var ambiColor = "#FFFAD2";
			var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
			scene.add(ambientLight);


			//LUZ FOCAL

			var light = new THREE.SpotLight(0xE9F736);
			light.position.set(25, 1, -32);
			light.penumbra = .5;
			light.target.position.set(0, 0, -32);
			light.intensity = 4;
			light.angle = Math.PI / 12;
			scene.add(light.target);
			scene.add(light);

			//LUZ DE FOCO 

			const light2 = new THREE.PointLight(0xE9F736, 1, 50);
			light2.position.set(18, 1, -32);
			scene.add(light2);

			const light3 = new THREE.PointLight(0xE9F736, 1, 50);
			light3.position.set(18, 1, -35);
			scene.add(light3);

			var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
			directionalLight.position.set(0, 0, 1);
			scene.add(directionalLight);

			var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
			grid.position.y = -1;
			scene.add(grid);


			$("#scene-section").append(renderer.domElement);
		}
	</script>
</head>

<body>
	<div id="scene-section" />

	<div class="progress-bar-container">
		<label for="progress-bar">Cargando...</label>
		<progress id="progress-bar" value="0" max="100"></progress>
	</div>
</body>

</html>